<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ¬∑ –ò–ö–ò —Å—Ç—Ä–∞–Ω–∏—Ü—ã</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Comfortaa", sans-serif;
        }
        body {
            background: rgba(171, 24, 3, 1);
            display: flex;
            justify-content: center;
            padding: 2rem 1.2rem;
        }
        .main {
            max-width: 900px;
            width: 100%;
        }
        .top-bar {
            background: rgba(171, 24, 3, 1);
            
            padding: 0.8rem 2rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            
        }
        
        .iki-meter span {
            color: white;
			
            font-size: 2.5rem;
            margin-right: 0.8rem;
        }
		
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .profile-btn {
            background: #eef3fc;
            padding: 0.5rem 1.5rem 0.5rem 1rem;
            border-radius: 40px;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            cursor: pointer;
            border: 1px solid #bacde8;
        }
        
        .login-btn {
            background: #1f2e50;
            color: white;
            border: none;
            padding: 0.6rem 2rem;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
        }
        .login-required {
            background: #ffedea;
            border-radius: 60px;
            padding: 3rem;
            text-align: center;
            font-size: 1.5rem;
            color: #ac3939;
            border: 2px dashed #cf9f9f;
            margin-bottom: 2rem;
        }
        .comment-form {
            background: white;
            
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .rating-group {
            display: flex;
            gap: 2rem;
            margin: 1.5rem 0;
            flex-wrap: wrap;
        }
        .rating-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #f2f6fe;
            padding: 0.6rem 1.5rem;
            border-radius: 40px;
            cursor: pointer;
        }
        .field input {
            width: 100%;
            padding: 1.2rem 1.8rem;
            border: 2px solid #dee9f7;
            border-radius: 60px;
            font-size: 1.1rem;
        }
        .field input:disabled {
            background: #f0f3f8;
            color: #666;
            cursor: not-allowed;
        }
        .submit-btn {
            background: #1f2e50;
            color: white;
            border: none;
            padding: 1.2rem 3rem;
            border-radius: 60px;
            font-size: 1.3rem;
            font-weight: 600;
            margin-top: 1rem;
            cursor: pointer;
            transition: 0.1s;
        }
        .submit-btn:hover {
            background: #2b3b60;
        }
        .submit-btn:disabled {
            background: #95a5c3;
            cursor: not-allowed;
            transform: none;
        }
        .already-left {
            background: #e3f0e3;
            border-radius: 60px;
            padding: 2rem;
            text-align: center;
            color: #1f7b4d;
            font-size: 1.3rem;
            margin-bottom: 2rem;
            border: 2px solid #a5d6a5;
        }
        .comments-header {
            display: flex;
            gap: 1rem;
            margin: 2rem 0 1rem;
        }
        .comment-card {
            background: white;
            border-radius: 40px;
            padding: 1.5rem 2rem;
            margin-bottom: 1rem;
        }
        .meta {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 0.8rem;
            flex-wrap: wrap;
        }
        .rating-badge {
            padding: 0.3rem 1.3rem;
            border-radius: 40px;
            font-weight: 600;
        }
        .pos { background: #dff0e3; color: #146c3a; }
        .neu { background: #fcf0d5; color: #9e7100; }
        .neg { background: #ffe4e2; color: #bc3b3b; }
        .empty-state { background: #ffffffc0; border-radius: 60px; padding: 3rem; text-align: center; }
        .user-comment-badge {
            background: #1f2e50;
            color: white;
            padding: 0.2rem 1rem;
            
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }
		h2{
		    color: white;
		}
		.count{
		    color: white;
		}
    </style>
</head>
<body>
<div class="main">
    <div class="top-bar">
	    
        <div class="iki-meter"><div style="padding: 5px; background-color:rgba(255, 0, 0, 1); border-radius: 20px 0 20px 0; height: 10px; margin-left: 0px;">  </div><span>–ò–ö–ò</span> <span id="ikiPageValue">0</span></div>
        <div id="userSection" class="user-info"></div>
		
    </div>

    <div id="commentFormContainer"></div>

    <div class="comments-header">
        <h2>–û—Ç–∑—ã–≤—ã</h2>
        <span class="count" id="commentsCount">0</span>
    </div>
    <div id="commentsList"><div class="empty-state">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD2nPoa3nFbO3Y2qBWlqeE-JnWHEV0cYCE",
        authDomain: "zorogamestoreapi.firebaseapp.com",
        databaseURL: "https://zorogamestoreapi-default-rtdb.firebaseio.com",
        projectId: "zorogamestoreapi",
        storageBucket: "zorogamestoreapi.firebasestorage.app",
        messagingSenderId: "163104730922",
        appId: "1:163104730922:web:3bc7c1641169ab93163853"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const PAGE_ID = new URLSearchParams(window.location.search).get('id') || 'default';
    let currentUser = null;
    let userAlreadyCommented = false; // –§–ª–∞–≥: –æ—Å—Ç–∞–≤–ª—è–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∑—ã–≤ –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ

    const userSection = document.getElementById('userSection');
    const commentFormContainer = document.getElementById('commentFormContainer');
    const ikiPageValue = document.getElementById('ikiPageValue');
    const commentsList = document.getElementById('commentsList');
    const commentsCountSpan = document.getElementById('commentsCount');

    // –°–ª—É—à–∞–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    auth.onAuthStateChanged(user => {
        currentUser = user;
        renderTopBar(user);
        
        if (user) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–≤–ª—è–ª –ª–∏ —ç—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∑—ã–≤ –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            checkIfUserCommented(user.uid).then(hasCommented => {
                userAlreadyCommented = hasCommented;
                renderCommentBlock(user, userAlreadyCommented);
            });
        } else {
            renderCommentBlock(null);
        }
    });

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –æ—Å—Ç–∞–≤–ª—è–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∑—ã–≤
    async function checkIfUserCommented(userId) {
        const snapshot = await db.ref('comments/' + PAGE_ID)
            .orderByChild('userId')
            .equalTo(userId)
            .once('value');
        
        return snapshot.exists(); // true –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    }

    // –ò–ö–ò —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const pageIkiRef = db.ref('pageIki/' + PAGE_ID);
    pageIkiRef.on('value', (snap) => {
        const iki = snap.val() || 0;
        ikiPageValue.textContent = iki;
    });

    function renderTopBar(user) {
        if (user) {
            
        } else {
            userSection.innerHTML = `<button class="login-btn" onclick="window.location.href='auth.html'">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>`;
        }
    }

    function renderCommentBlock(user, hasCommented = false) {
        if (!user) {
            commentFormContainer.innerHTML = `<div class="login-required">–¢–û–õ–¨–ö–û –ê–í–¢–û–†–ò–ó–ò–†–û–í–ê–ù–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò –ú–û–ì–£–¢ –ü–ò–°–ê–¢–¨ –û–¢–ó–´–í–´</div>`;
            return;
        }

        if (hasCommented) {
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –æ—Å—Ç–∞–≤–ª—è–ª –æ—Ç–∑—ã–≤
            commentFormContainer.innerHTML = `
                <div class="already-left">
                    –í—ã —É–∂–µ –æ—Å—Ç–∞–≤–∏–ª–∏ –æ—Ç–∑—ã–≤ –Ω–∞–¥ —ç—Ç–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º<br>
                    
                </div>
            `;
            return;
        }

        // –§–æ—Ä–º–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –æ—Ç–∑—ã–≤–∞
        commentFormContainer.innerHTML = `
            <form class="comment-form" id="commentForm">
                <div class="rating-group">
                    <label class="rating-option"><input type="radio" name="rating" value="positive" required> <span class="pos">üòä –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è (+10 –ò–ö–ò)</span></label>
                    <label class="rating-option"><input type="radio" name="rating" value="neutral"> <span class="neu">üòê –ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è (+5 –ò–ö–ò)</span></label>
                    <label class="rating-option"><input type="radio" name="rating" value="negative"> <span class="neg">üôÅ –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è (-10 –ò–ö–ò)</span></label>
                </div>
                <div class="field">
                    <input type="text" id="commentText" placeholder="–í–∞—à –æ—Ç–∑—ã–≤..." required>
                </div>
                <button type="submit" class="submit-btn" id="submitCommentBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        `;
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–≤–æ–π–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
        const form = document.getElementById('commentForm');
        const submitBtn = document.getElementById('submitCommentBtn');
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Ñ–ª–∞–≥ –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è)
            if (userAlreadyCommented) {
                alert('–í—ã —É–∂–µ –æ—Å—Ç–∞–≤–ª—è–ª–∏ –æ—Ç–∑—ã–≤ –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ');
                return;
            }

            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            submitBtn.disabled = true;
            submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

            const rating = document.querySelector('input[name="rating"]:checked')?.value;
            const text = document.getElementById('commentText').value.trim();
            
            if (!rating || !text) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ü–µ–Ω–∫—É –∏ –Ω–∞–ø–∏—à–∏—Ç–µ –æ—Ç–∑—ã–≤');
                submitBtn.disabled = false;
                submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
                return;
            }

            // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Firebase (–Ω–∞ —Å–ª—É—á–∞–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)
            const alreadyLeft = await checkIfUserCommented(user.uid);
            if (alreadyLeft) {
                alert('–í—ã —É–∂–µ –æ—Å—Ç–∞–≤–ª—è–ª–∏ –æ—Ç–∑—ã–≤ (–æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –≤ –±–∞–∑–µ)');
                userAlreadyCommented = true;
                renderCommentBlock(user, true);
                return;
            }

            let ikiDelta = 0;
            if (rating === 'positive') ikiDelta = 10;
            else if (rating === 'neutral') ikiDelta = 5;
            else if (rating === 'negative') ikiDelta = -10;

            try {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                await db.ref('comments/' + PAGE_ID).push({
                    userId: user.uid,
                    userName: user.displayName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                    rating: rating,
                    text: text,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º –ò–ö–ò —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                await pageIkiRef.transaction(currentIki => (currentIki || 0) + ikiDelta);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–ª–∞–≥ –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                userAlreadyCommented = true;
                renderCommentBlock(user, true);

            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
            }
        });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
    function loadComments() {
        db.ref('comments/' + PAGE_ID).on('value', (snap) => {
            const data = snap.val();
            if (!data) {
                commentsList.innerHTML = '<div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</div>';
                commentsCountSpan.textContent = '0';
                return;
            }
            
            const arr = Object.keys(data).map(k => ({ id: k, ...data[k] }));
            arr.sort((a,b) => (b.timestamp||0) - (a.timestamp||0));
            commentsCountSpan.textContent = arr.length;
            
            let html = '';
            arr.forEach(c => {
                let ratingClass = c.rating === 'positive' ? 'pos' : c.rating === 'neutral' ? 'neu' : 'neg';
                let ratingText = c.rating === 'positive' ? '–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è' : c.rating === 'neutral' ? '–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è' : '–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è';
                
                // –û—Ç–º–µ—á–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏)
                const isCurrentUser = currentUser && c.userId === currentUser.uid;
                const userBadge = isCurrentUser ? '<span class="user-comment-badge">—ç—Ç–æ –≤—ã</span>' : '';
                
                html += `
                    <div class="comment-card">
                        <div class="meta">
                            <span style="font-weight:700;">${c.userName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} ${userBadge}</span>
                            <span class="rating-badge ${ratingClass}">${ratingText}</span>
                        </div>
                        <div>${c.text}</div>
                    </div>
                `;
            });
            commentsList.innerHTML = html;
        });
    }

    loadComments();
</script>
</body>
</html>